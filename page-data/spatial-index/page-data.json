{"componentChunkName":"component---src-templates-post-jsx","path":"/spatial-index/","result":{"data":{"site":{"siteMetadata":{"title":"괜찮을지도"}},"markdownRemark":{"id":"cae8fd6f-eff4-5fff-9917-cebb22df92ab","excerpt":"이 글은 우아한테크코스 괜찮을지도팀의 가 작성했습니다. 배경  서비스는 아래와 같이, 위치와 관련된 정보를 별도의 테이블로 관리하고 있습니다.  장소를 등록할 때, 주소 검색을 사용할 수도 있지만, 지도 위의 좌표를 클릭하여 등록할 수도 있습니다.\n 사용자들이 동일한 장소를 등록하기 위해 지도상의 특정 위치를 클릭한다고 가정해 보겠습니다.\n 이때, 미터 …","html":"<blockquote>\n<p>이 글은 우아한테크코스 괜찮을지도팀의 <code class=\"language-text\">쥬니</code>가 작성했습니다.</p>\n</blockquote>\n<h3>배경</h3>\n<p><code class=\"language-text\">괜찮을지도</code> 서비스는 아래와 같이, 위치와 관련된 정보를 별도의 테이블로 관리하고 있습니다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/9eb08cee88053e732c4f75755a33f56a/3a6ec/diagram.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 39.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWklEQVR42n2R3UvDMBTF+9eLD+qb+CAqOAXdBBEcMhUcw02ngmMyEEWUtlu72Tb9WtqmrcckutLB9OFA7s09v5xwlftnDau1a6xwrR21sXzQQrX5hK88Q5qmhRhLwZv4MB0cNvvYv+yhcvEotcfPW2cP6L8ZUPqvGiqNO1Sveqhx7dQ7aNwOuDcHK2AMSZJI4Is6xnb9BpunXawft6U2TjpY2j1Hd/AOJYmmoD4BUm7IYsSBi5iGSLOsgAkVaVmCqUcQh64U8gQ5o4gCwhERlCAIoGoaLNuG5/twCIHrusgWAEWP0giapkPTdZjjMVzPx6dlQx+NEAQhlDAMMeIF4SABJ7/AMqwMjKJIzluWBZ8HEBIe0zQhWD8JVRWO48hLwzBg87SLvjsDDofDOaDwFkBKKSaTCTzPkw0BE4+UNzy/bQbhEWCxKKE4jmUt7pTZy+UUf8H+m5n1vgGdU1mhOVDnIQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='diagram.png' title='' src='/static/9eb08cee88053e732c4f75755a33f56a/ca1dc/diagram.png' srcset='/static/9eb08cee88053e732c4f75755a33f56a/e7570/diagram.png 170w,\n/static/9eb08cee88053e732c4f75755a33f56a/f46e7/diagram.png 340w,\n/static/9eb08cee88053e732c4f75755a33f56a/ca1dc/diagram.png 680w,\n/static/9eb08cee88053e732c4f75755a33f56a/3a6ec/diagram.png 686w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>diagram.png</figcaption>\n  </figure></p>\n<p>장소를 등록할 때, 주소 검색을 사용할 수도 있지만, <strong>지도 위의 좌표를 클릭하여 등록</strong>할 수도 있습니다.\n<br> 사용자들이 동일한 장소를 등록하기 위해 지도상의 특정 위치를 클릭한다고 가정해 보겠습니다.\n<br> 이때, 미터 혹은 그 이하의 오차 없이 동일한 위치를 선택할 확률은 얼마나 될까요 ?\n<br> 거의 불가능에 가깝다고 생각합니다.\n<br> 물론, 사용자의 입력을 그대로 저장할 필요도 있었습니다.\n<br> 하지만, 데이터의 정확성이 크게 요구되는 서비스는 아니라는 점에서, DB 공간을 효율적으로 관리하는 것이 우선시 되었습니다.\n<br> 이에 따라, 등록 장소 반경 10M 이내에 좌표가 존재하는 경우, 기존 좌표를 재사용하기 위해 테이블을 분리한 것이었죠.</p>\n<p>데이터 공간의 효율성을 위해, 장소 등록시 마다 매번 위치 좌표와 관련된 쿼리가 수행되고 있었습니다.\n<br> 물론, 조회용 API에서 해당 로직을 수행하지 않기 때문에 인덱싱의 중요성이 그리 높지 않았습니다.\n<br> 하지만, 추후 사용자의 접속 위치를 기반으로 여러 기능들을 제공할 계획을 가지고 있습니다.\n<br> 현재의 기능을 위해서도, 앞으로의 기능을 위해서도 공간 인덱스 적용은 반드시 필요한 상황이었습니다.</p>\n<h3>공간 인덱스</h3>\n<p>공간 인덱스는 2차원 공간 개념 값을 다루는 R-Tree 알고리즘을 사용합니다.\n<br> 이러한 R-Tree 알고리즘을 이해하기 위해서는 <code class=\"language-text\">MBR</code>이라는 개념이 필수적입니다.\n<br> MBR(Minimum Bounding Rectangle)은 아래 사진 하나로 설명이 가능할 것 같습니다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/3c9f6647f7be530335496f99755fd238/2d81a/mbr.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 44.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRUlEQVR42nVS2W6DQAzk/z+nqvoBjSrlgYcoQjlIRZo2XOFIOAMkYcq4WgREtWTtrr0ez3hXu91uSNMUbdtCGWN5no9itPv9jjRLUdf1KF4UBeI4QlVV0MqygGmaAjK8cDz+YGplWWK9XmO5XI6anU4nrFYrZFkGbVjAS2RBi+MYURSNWF+rKy6XC3a7HXzf73Pczz/msgrgZrNB0zSSZAHd8/yu8FP2tCRJYBhGD05Vytj89eUN+/3XHyAl0jmD7XYrIGTKlTIUCM/ME8C27V4VZzp7nyFLJ5Ifj4cUclYEoivmahwcg+d5Io85EuF99QYa/jEWs4A/gHLZjArIhnvmCTL9CU+ALA7DULqez7GcyUrXdSwWCwRB0OUDiXMEXIeg2vCF1RewLAtBtx6+D508V2bmOI6467oimU0dxxbpZKwAfwG83rW/bmsBfAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img.png' title='' src='/static/3c9f6647f7be530335496f99755fd238/ca1dc/mbr.png' srcset='/static/3c9f6647f7be530335496f99755fd238/e7570/mbr.png 170w,\n/static/3c9f6647f7be530335496f99755fd238/f46e7/mbr.png 340w,\n/static/3c9f6647f7be530335496f99755fd238/ca1dc/mbr.png 680w,\n/static/3c9f6647f7be530335496f99755fd238/2d81a/mbr.png 840w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>img.png</figcaption>\n  </figure></p>\n<blockquote>\n<p>출처 : Real My SQL 8.0</p>\n</blockquote>\n<p>MySQL에서는 공간 정보를 나타내는 데이터 타입으로 Point, Line, Polygon, Geometry를 지원합니다.\n<br> MBR은 이러한 데이터 타입을 감쌀 수 있는 최소 크기의 사각형을 의미합니다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 548px; '>\n      <a class='gatsby-resp-image-link' href='/static/ad58f108c7db6fa790c4ed37ea50ede1/9079b/r-tree.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 65.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKElEQVR42nVTa28SQRTl/38yJiam0fiiVNimSW2t0mXB1FQp9hUFF4QmtgoEdpf37vJajnPudmg1cZLLXIY7555z5pIYj8dwHAeLxQKz2UyC+f3o9/tg3Wg0wmQyWZ+HYYhpOMV0GgdXwvd9AdRrtVqtQy8za+H87AKe56HT6cDpOqjVfiiQUIDmszn8iY9oGSHBC57XQ6l0ipNiCY3GlXRnIdnyknloIfvORBQtMZ/PpdbIbAtrNmbd9c9r9fst4M3NL7x4toknG8/x6bgorKIoZshiAqaSafR6PQEcDocIggBUR9a1Wh3lciWWzA96Q58YpB4DRmufcmYBG4+fovm7KWcE1YsEki+3xIY1QwKym/aQ6+PRMZKvUqhWayhYR9jZ3hVW2gpd9+1rBVbuAyZK/kI1EkBKaTabUkxGjFarhXq9oR6hi/03b9WlvAAQlICaSOa1gapdQxAGwlwAmdx/1X/X2ek5rtRjEYj+acnM01sGPNdTDCd3gPTlf4DL5VJ2267i4YNHKH4+geu5ck7PvqgX9/0Ag8Hwb4Zaqh5SnVPiUEnj3O3tHoinnW5HAQwk2u22jB1zNkloZgNF//LiUl6anrquKzvHotvtot/rCzAv6hqyorpK+TsMY0eGPqFnzbZtMZ6RtwpqVCxYZh6HWROZtIHs+5zKc/Kd+/7egfx7tB2byZQi4dxJJiOazO5kQQbxbN4yUrLIkhEr8KSe1tAWBtn+AZpBynJQvy4jAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='r-tree.png' title='' src='/static/ad58f108c7db6fa790c4ed37ea50ede1/9079b/r-tree.png' srcset='/static/ad58f108c7db6fa790c4ed37ea50ede1/e7570/r-tree.png 170w,\n/static/ad58f108c7db6fa790c4ed37ea50ede1/f46e7/r-tree.png 340w,\n/static/ad58f108c7db6fa790c4ed37ea50ede1/9079b/r-tree.png 548w' sizes='(max-width: 548px) 100vw, 548px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>r-tree.png</figcaption>\n  </figure></p>\n<blockquote>\n<p>출처 : Real My SQL 8.0</p>\n</blockquote>\n<p>이러한 MBR의 포함 관계를 위 사진처럼 나타낼 수 있습니다.\n<br> 이를 B-Tree 형태로 구현한 인덱스가 R-Tree 인덱스입니다.</p>\n<p>이 정도의 지식만 있으면, 공간 인덱스를 적용하는 데에 큰 어려움은 없습니다. </p>\n<h3>기존 코드</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">// LocationRepository.class</span>\n\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"SELECT l FROM Location l \"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\"WHERE ( 6371000 * acos( cos( radians(:#{#current_coordinate.latitude}) ) \"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\"      * cos( radians( l.coordinate.latitude ) ) \"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\"      * cos( radians( l.coordinate.longitude ) - radians(:#{#current_coordinate.longitude}) ) \"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\"      + sin( radians(:#{#current_coordinate.latitude}) ) \"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\"      * sin( radians( l.coordinate.latitude ) ) ) ) &lt;= :distance\"</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Location</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllByCoordinateAndDistanceInMeters</span><span class=\"token punctuation\">(</span>      \n            <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"current_coordinate\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Coordinate</span> coordinate<span class=\"token punctuation\">,</span>\n            <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"distance\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">double</span> distance\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>공간 인덱스를 적용하기 전, 등록 좌표를 기준으로 특정 반경 내에 존재하는 좌표를 조회하는 로직입니다.\n<br> 위 로직은 <code class=\"language-text\">좌표 기반 거리 계산을 위한 Haversine 공식</code>을 적용한 것입니다.\n<br> 로직을 이해하기도 어렵고, Table Full Scan을 통해 쿼리가 수행되므로, 성능 개선이 필요한 상태입니다.</p>\n<h3>공간 인덱스 적용</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//build.gradle</span>\n\nimplementation 'org<span class=\"token punctuation\">.</span>hibernate<span class=\"token operator\">:</span>hibernate<span class=\"token operator\">-</span>spatial<span class=\"token operator\">:</span><span class=\"token number\">6.2</span><span class=\"token number\">.5</span><span class=\"token punctuation\">.</span>Final'</code></pre></div>\n<p>우선, 공간 인덱스를 적용하기 위해 위와 같은 의존성을 추가해 줍니다.\n<br> 버전은 프로젝트에서 사용하고 있는 JPA 버전에 따라 달라집니다.</p>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">// Location.class</span>\n\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token comment\">/*\n     * 4326은 데이터베이스에서 사용하는 여러 SRID 값 중, 일반적인 GPS기반의 위/경도 좌표를 저장할 때 쓰이는 값입니다.\n     * */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GeometryFactory</span> geometryFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GeometryFactory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PrecisionModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>columnDefinition <span class=\"token operator\">=</span> <span class=\"token string\">\"geometry SRID 4326\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Point</span> coordinate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Coordinate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Point</span> point<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>coordinate <span class=\"token operator\">=</span> point<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Coordinate</span> <span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> latitude<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> longitude<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">validateRange</span><span class=\"token punctuation\">(</span>latitude<span class=\"token punctuation\">,</span> longitude<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Point</span> point <span class=\"token operator\">=</span> geometryFactory<span class=\"token punctuation\">.</span><span class=\"token function\">createPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>locationtech<span class=\"token punctuation\">.</span>jts<span class=\"token punctuation\">.</span>geom<span class=\"token punctuation\">.</span></span>Coordinate</span><span class=\"token punctuation\">(</span>longitude<span class=\"token punctuation\">,</span> latitude<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Coordinate</span><span class=\"token punctuation\">(</span>point<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>위 코드에서 주의 깊게 보아야 할 점은 <code class=\"language-text\">SRID</code>입니다.\n<br> SRID는 여러 좌표(평면 좌표, 공간 좌표 등)를 나타내는 식별자라고 생각하시면 됩니다.\n<br> 만약, SRID 값이 서로 다를 경우, 공간 인덱스를 적용할 수 없습니다.\n<br> (엄밀히 이야기하자면, 인덱스를 타지 않는다고 표현하는 것이 맞는 것 같습니다.)\n<br> 힘들게 공간 인덱스를 적용했는데 ! 실제 쿼리에서 Full-Scan이 일어난다면.. 마음이 아프겠죠 ?\n<br> 코드 주석으로도 남겨져 있지만, 일반적인 위/경도 좌표를 저장할 때 쓰이는 값인 <code class=\"language-text\">4326</code>으로 SRID 값을 설정하였습니다.</p>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">// LocationRepository.class</span>\n\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"SELECT l FROM Location l \"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\"WHERE ST_Contains(ST_Buffer(:coordinate, :distance), l.coordinate.coordinate)\"</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Location</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllByCoordinateAndDistanceInMeters</span><span class=\"token punctuation\">(</span>\n            <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"coordinate\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Point</span> coordinate<span class=\"token punctuation\">,</span>\n            <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"distance\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">double</span> distance\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>드디어 마지막 단계입니다.\n<br> 위 코드에서 <code class=\"language-text\">ST_Contains</code>와 <code class=\"language-text\">ST_Buffer</code>라는 함수가 생소하실 텐데요.\n<br> 이는 MySQL에서 공간 인덱스를 지원해 주는 함수입니다.\n<br> 각 함수를 간단하게 설명하자면 다음과 같습니다.\n<strong><br> ST_Buffer(Coordinate, Distance) : Coordinate로부터, Distance(Meter)내에 존재하는 MBR을 반환한다.</strong>\n<strong><br> ST_Contains(MBR, Coordinate) : MBR 이내에 해당 Coordinate의 포함 여부를 반환한다.</strong>\n<br> 이처럼, MySQL에서 지원해주는 함수를 통해 공간 인덱스를 적용할 모든 준비가 끝났습니다.</p>\n<p>물론, 위 로직에서는 한 가지 문제가 존재합니다.\n<br><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 282px; '>\n      <a class='gatsby-resp-image-link' href='/static/4a703b890030da2757d4709ef387cf27/75fda/st_buffer-st_contains.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 95.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACaklEQVR42o2Uz0sbQRTH/VP0oKjg7x8XQS8qCOKPsydvXiQ5eNGDPzBUhYKYksbSELQE66qYtiElevAHKJQWGgvSaw89FCnYRO12d7Mz376ZTdbsZtNm4TGzb9989r3vvJkqzjkKxhgrMW6aDvOMKWJUFb8AwpwPc5nX4wkUz+d0GkepFI5PTpA8P8enw0P8DAaRCwRgLi/jdn0dV8oe3p+d4ej0FMcUe3F56YA6gPuKggVa/HRlBR9HRqDW14PX1ADV1dLEXK+txfXgIJ4tLWFhdRUvwuHywHgigeDaGm6GhoCGBvD2dqCz89E6OixfYyOyfX2I0M+jsZhUyhN4kEziijITCxgtRlubp8lvFPOtvx9b29ulGdJWwSTnh0gEGgVCZFEGVjAusqUqLhYXocvdYwUgvZhMOm/m5wHSSJZXARCk8Y/JSeRkiqyoZNFP5DN8fqCuriIg8mUb4+Oy2ZwainRFoj6fBfyHfm5gbmzMDbTqN2jIzM5WXLIEkoa3ExNSf7g3RQCvNzaQI10qATIRQ7FfZmbcmyJKttrm3Zs4vvf2Ai0tMP/XNjT+6u7G3mZY6i8Ynn0Yo7JNCkRrK1hXl93QsqlpLnxcgOl7gjR/ubNjl1sCfBuPI0DndX9uDpmeHik6b2oCmpulyTn5VIIm/X48IYm2olF3Y8MGpuiwh0MhPKfuf0Vjenoad6OjYAMD4HQqfg8P4+vUFF4TKEQxm3SOlV3F+ywLpqZpUFUVGtmDriNDQj/oBsy7e7Bs1vbdG4aMEbF/aE3Z+1Ba/lbkVurIDyiuxHkHltyHcDi9Lk27+csCYc//Al2kyPAhJdWGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img.png' title='' src='/static/4a703b890030da2757d4709ef387cf27/75fda/st_buffer-st_contains.png' srcset='/static/4a703b890030da2757d4709ef387cf27/e7570/st_buffer-st_contains.png 170w,\n/static/4a703b890030da2757d4709ef387cf27/75fda/st_buffer-st_contains.png 282w' sizes='(max-width: 282px) 100vw, 282px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>img.png</figcaption>\n  </figure></p>\n<blockquote>\n<p>출처 : 매튜</p>\n</blockquote>\n<p>위 사진 속 원의 원점이 좌표라고 가정하면 특정 거리 내의 좌표들은 빨간색 원 이내에 존재해야 합니다.\n<br> 하지만, 위 로직에서는 회색의 잉여 공간(?)이 존재하게 됩니다.\n<br> 즉, 특정 거리보다 더 멀리 있는 좌표들도 조회할 수 있게 되는 문제가 발생합니다.\n<br> 이를 해결하는 방법은 <code class=\"language-text\">ST_DISTANCE</code>라는 함수를 사용하는 것입니다.\n<br> 하지만, 해당 함수는 공간 인덱스를 지원하지 않는다는 단점이 존재합니다.\n<br> 정확성이 요구되는 서비스라면, 공간 인덱스를 사용하기 어렵다는 뜻이죠.\n<br> 우리 서비스에서는 <code class=\"language-text\">엄청난 정확성을 요구하지 않는다는 점</code>과 <code class=\"language-text\">성능 향상</code>의 이유에서 위의 로직을 그대로 가져가기로 결정했습니다. </p>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> location <span class=\"token keyword\">ADD</span> <span class=\"token keyword\">COLUMN</span> coordinate <span class=\"token keyword\">GEOMETRY</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> SRID <span class=\"token number\">4326</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>만약, 해당 테이블 새로 생성한 것이 아니라, 기존 테이블 구조를 변경한다면 SRID 값을 명시적으로 설정해 주어야 합니다.</strong>\n<strong><br> 단순히 컬럼만 추가한다면, SRID 값이 0으로 설정되기 때문이죠.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> spatial <span class=\"token keyword\">index</span> location_idx01 <span class=\"token keyword\">on</span> location<span class=\"token punctuation\">(</span>coordinate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>마지막으로, 데이터베이스에 위와 같은 쿼리를 수행함으로써 공간 인덱스 적용이 끝나게 됩니다.</p>\n<h3>성능 테스트</h3>\n<p>총 데이터는 약 10만건이 존재하며, 1km 이내의 데이터, 3km 이내의 데이터 조회를 수행하였습니다.</p>\n<p>공간 인덱스 적용 전\n1km 이내 (40건)<br>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 631px; '>\n      <a class='gatsby-resp-image-link' href='/static/864352edc04fe0fb8a9ce4fc2b6fc381/077d3/test-not-spatial-1km.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVR42oWR2U6FMBRFC2EqBaSFMIaZa7ySG///67Y9RzFGDT7slBS69uJUlGUJGUUIZYzeaOypxFRoLFWJlyyGUTFyYyClhOM4EEJc5zgOzPOMqqrwlOcoohC178E4Asr5feA79Hz+USS4vW4adG2LpuvQTxMbqyRBlmWc3JalaQrf968NT7pSik1f73e8PR54vt0wjSO2bcO+70gsnKC0BkHAiWhUYcgrSX2WfZDpg9YaruvKkMla1nWNYRg4WmsuXJYFxs6UbIui4BJ6RyGoOGdAwL7v2YZyznW0lgQkMzpARpeX43ne1++cm67rcv690T/yDhUVneoxoQXOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='test-not-spatial-1km.png' title='' src='/static/864352edc04fe0fb8a9ce4fc2b6fc381/077d3/test-not-spatial-1km.png' srcset='/static/864352edc04fe0fb8a9ce4fc2b6fc381/e7570/test-not-spatial-1km.png 170w,\n/static/864352edc04fe0fb8a9ce4fc2b6fc381/f46e7/test-not-spatial-1km.png 340w,\n/static/864352edc04fe0fb8a9ce4fc2b6fc381/077d3/test-not-spatial-1km.png 631w' sizes='(max-width: 631px) 100vw, 631px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>test-not-spatial-1km.png</figcaption>\n  </figure></p>\n<p>3km 이내 (300건)<br>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/211d1b93e00e49752380933d5a6356f8/00c79/test-not-spatial-3km.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 52.94117647058824%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWklEQVR42pVS2W6DQBBbbrIQyMENCYqCCAX1/z/PHW8Filq1TR+sZWeQx+uxapoGWZbhdDqZs6lr1FWFSGtEUYS2bU0vCAKEYWjA75/uyvd9c3FdF47rwSY8D5ZlwbZtsM+eUuo1xHEMItrvUScxxjTGIJiOCao0gZbeXnpJkmzg/bn2fFecvhOpWgrvqcZSF5ivHeYyxxSHOIoNtIKvoGIq/w3qer1+ThD2bBeishVa30EniGz5SUhI9PKT8zxHI8ZXsggdxShkScFOS9MST11DxleseCb/po51fnCbfd/jdrvhbZrQi+pcntl1ndkycT6fjUcvLEiZqVR4v9+xLAvmeQatIFgj2RqhWmKVpikOhwOKotjiRtA6tUovyxLjOOLxeBgwnyQchgGXy8UQ8SQJ8+ZJtHiusdvi5TiOUUh2klIpTyqgEk7WEvLNo79AInrFiWvxX0H+gg+BVPc0ndVKzgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='test-not-spatial-3km.png' title='' src='/static/211d1b93e00e49752380933d5a6356f8/ca1dc/test-not-spatial-3km.png' srcset='/static/211d1b93e00e49752380933d5a6356f8/e7570/test-not-spatial-3km.png 170w,\n/static/211d1b93e00e49752380933d5a6356f8/f46e7/test-not-spatial-3km.png 340w,\n/static/211d1b93e00e49752380933d5a6356f8/ca1dc/test-not-spatial-3km.png 680w,\n/static/211d1b93e00e49752380933d5a6356f8/00c79/test-not-spatial-3km.png 879w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>test-not-spatial-3km.png</figcaption>\n  </figure></p>\n<p>공간 인덱스 적용 후\n1km 이내 (40건)<br>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/14c3ee91ccfcfdb7d96661b680facd32/3bd09/test-spatial-1km.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 8.235294117647058%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXElEQVR42o2OzQqAMAyDu11q1/1UGQMvvoD4/o8X7UDPHsKXlAZChy64uuG0jC0JWAQhBBDR5B/FGL8Ojd6xr4ZhDaVktOYsSCmh1gpVnfS7+ze7/EeeAU7vMDNum+ksGmreviMAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='test-spatial-1km.png' title='' src='/static/14c3ee91ccfcfdb7d96661b680facd32/ca1dc/test-spatial-1km.png' srcset='/static/14c3ee91ccfcfdb7d96661b680facd32/e7570/test-spatial-1km.png 170w,\n/static/14c3ee91ccfcfdb7d96661b680facd32/f46e7/test-spatial-1km.png 340w,\n/static/14c3ee91ccfcfdb7d96661b680facd32/ca1dc/test-spatial-1km.png 680w,\n/static/14c3ee91ccfcfdb7d96661b680facd32/3bd09/test-spatial-1km.png 896w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>test-spatial-1km.png</figcaption>\n  </figure></p>\n<p>3km 이내 (300건)<br>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/fc391f90d439899ede99d95b34f42266/6f18b/test-spatial-3km.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 9.411764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAX0lEQVR42mWNSwrAIAxERQU1mvjBnqD0AL3/4aZGKBS6eGTyFjOGa8U5Ku4puIQgpSCEAOccvPc/vt5a+/OGmdFW6TEnRmvovUNEkFICEW3KGlFel3PeV4djjPvXrO4B2k4sZc5AZW0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='test-spatial-3km.png' title='' src='/static/fc391f90d439899ede99d95b34f42266/ca1dc/test-spatial-3km.png' srcset='/static/fc391f90d439899ede99d95b34f42266/e7570/test-spatial-3km.png 170w,\n/static/fc391f90d439899ede99d95b34f42266/f46e7/test-spatial-3km.png 340w,\n/static/fc391f90d439899ede99d95b34f42266/ca1dc/test-spatial-3km.png 680w,\n/static/fc391f90d439899ede99d95b34f42266/6f18b/test-spatial-3km.png 886w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>test-spatial-3km.png</figcaption>\n  </figure></p>\n<p><strong>성능이 최소 10배 이상 차이 나는 것을 확인할 수 있었습니다.</strong></p>\n<p><strong>예비군으로 인해, 대신 성능 테스트를 진행해 준 <code class=\"language-text\">준팍</code> 고맙습니다 !</strong></p>\n<h3>마치며</h3>\n<p>공간 인덱스 적용을 위해 사용한 함수들은 <code class=\"language-text\">MySQL</code>에서 지원하는 함수입니다.\n<br> 즉, 테스트 환경이 <code class=\"language-text\">H2</code>라면 오류가 발생할 수 있습니다.\n<br> <code class=\"language-text\">H2</code>에서는 지원해 주지 않는 함수들이기 때문이죠.\n<br> 이런 상황에서는 <code class=\"language-text\">TestContainer</code>를 통해 해결할 수 있습니다.</p>\n<p>테스트 환경이 <code class=\"language-text\">MySQL</code>이더라도, <code class=\"language-text\">@DataJpaTest</code>를 사용한다면 오류가 발생할 수 있습니다.\n<br> 내부적으로 인메모리 <code class=\"language-text\">H2</code>를 사용하기 때문인데요.\n<br> <code class=\"language-text\">@AutoConfigureTestDatabase(replace = Replace.NONE)</code>설정을 통해 해결할 수 있습니다.</p>\n<h3>참고</h3>\n<p>Real My SQL 8.0 1판/2판</p>","frontmatter":{"title":"공간 인덱스 적용기","date":"October 19, 2023","update":"October 19, 2023","tags":["MySQL","인덱스","공간 인덱스"],"series":null},"fields":{"slug":"/spatial-index/","readingTime":{"minutes":10.765}}},"seriesList":{"edges":[{"node":{"id":"9e6463d2-18de-5fdf-b4e6-8707709710e1","fields":{"slug":"/how-to-write-a-post/"},"frontmatter":{"title":"포스트 작성 방법"}}},{"node":{"id":"b802f2fe-d332-504c-be84-fd7aa170c622","fields":{"slug":"/github-actions-ci-cd/"},"frontmatter":{"title":"GitHub Actions로 CI/CD 구축하기"}}},{"node":{"id":"45b7dc00-ae71-58e4-9dc2-7aff92f0ca0d","fields":{"slug":"/trouble-shooting-actions-runner/"},"frontmatter":{"title":"EC2 환경 변수 적용 및 Actions Runner에 환경 변수 적용이 안되는 이슈"}}},{"node":{"id":"cb221d09-1977-59c9-9bc3-cd607a15d292","fields":{"slug":"/how-to-isolating-test/"},"frontmatter":{"title":"인수테스트에서 테스트 격리하기!"}}},{"node":{"id":"fa602b8b-64fa-59b0-b377-089612f91d9f","fields":{"slug":"/how-to-use-nginx/"},"frontmatter":{"title":"괜찮을지도의 Nginx 활용법"}}},{"node":{"id":"89dc33ed-1ad0-5d79-8148-b1a16f417a71","fields":{"slug":"/trouble-shooting-modifying-annotation/"},"frontmatter":{"title":"@Modifying 어노테이션의 옵션이 정상 동작하지 않는 문제"}}},{"node":{"id":"db91695e-5bf6-554c-bafd-e161d686fadf","fields":{"slug":"/trouble-shooting-fetch-type/"},"frontmatter":{"title":"FetchType.EAGER, FetchType.LAZY 에 대해서 알아보자!"}}},{"node":{"id":"2b3c31ce-d59e-50a0-92b2-7dc228aacf29","fields":{"slug":"/jpa-multibag-fetch-exception/"},"frontmatter":{"title":"Fetch join 사용 시 MultipleBagFetchException의 발생 이유와 해결 방법"}}},{"node":{"id":"253d110b-e241-549e-923a-f26782aab2dc","fields":{"slug":"/how-to-hikariCP/"},"frontmatter":{"title":"HikariCP 적용기"}}},{"node":{"id":"50f61fc3-c2e2-5599-b7e8-64879a64275d","fields":{"slug":"/trouble-shooting-jpa-delete-and-persistence/"},"frontmatter":{"title":"JPA 엔티티를 삭제할 때 영속성과 연관 관계가 중요한 이유"}}},{"node":{"id":"5a782fff-6a5b-55c2-af81-7c69e2b2ddac","fields":{"slug":"/set-or-list/"},"frontmatter":{"title":"N + 1 문제 해결 도중 맞닥뜨린 Set 과 List 의 차이"}}},{"node":{"id":"4a76962f-5c50-5617-84e6-286b77281734","fields":{"slug":"/how-to-optimize-website/"},"frontmatter":{"title":"괜찮을지도 사이트 최적화 진행"}}},{"node":{"id":"17b8f808-e28d-5eb8-a407-fba6191a1ea7","fields":{"slug":"/how-to-store-image-s3/"},"frontmatter":{"title":"백엔드와 협력해 S3에 이미지 저장하기"}}},{"node":{"id":"cae8fd6f-eff4-5fff-9917-cebb22df92ab","fields":{"slug":"/spatial-index/"},"frontmatter":{"title":"공간 인덱스 적용기"}}}]},"previous":{"fields":{"slug":"/how-to-store-image-s3/"},"frontmatter":{"title":"백엔드와 협력해 S3에 이미지 저장하기"}},"next":null},"pageContext":{"id":"cae8fd6f-eff4-5fff-9917-cebb22df92ab","series":null,"previousPostId":"17b8f808-e28d-5eb8-a407-fba6191a1ea7","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}