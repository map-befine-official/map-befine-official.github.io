{"componentChunkName":"component---src-templates-post-jsx","path":"/how-to-hikariCP/","result":{"data":{"site":{"siteMetadata":{"title":"괜찮을지도"}},"markdownRemark":{"id":"253d110b-e241-549e-923a-f26782aab2dc","excerpt":"이 글은 우아한테크코스 괜찮을지도팀의 가 작성했습니다. 배경 CPU 코어가 하나인 컴퓨터라도 수십 또는 수백 개의 쓰레드를  지원할 수 있습니다.\n 하지만, 실제로 하나의 코어는 하나의 쓰레드만 실행할 수 있습니다.\n 을 통해, 하나의 코어에서도 여러 개의 쓰레드를 동시에 지원할 수 있는 것이죠. 물론, 두 개의 쓰레드 A, B가 존재할 때 이를 순차적으…","html":"<blockquote>\n<p>이 글은 우아한테크코스 괜찮을지도팀의 <code class=\"language-text\">쥬니</code>가 작성했습니다.</p>\n</blockquote>\n<h3>배경</h3>\n<p>CPU 코어가 하나인 컴퓨터라도 수십 또는 수백 개의 쓰레드를 <code class=\"language-text\">동시에</code> 지원할 수 있습니다.\n<br> 하지만, 실제로 하나의 코어는 하나의 쓰레드만 실행할 수 있습니다.\n<br> <code class=\"language-text\">쓰레드 스케줄링</code>을 통해, 하나의 코어에서도 여러 개의 쓰레드를 동시에 지원할 수 있는 것이죠.</p>\n<p>물론, 두 개의 쓰레드 A, B가 존재할 때 이를 순차적으로 실행하는 것이 성능적으로는 더 빠릅니다.\n<br> <code class=\"language-text\">Context Switching Overhead</code>가 없기 때문이죠 !</p>\n<p>그렇다면, 어플리케이션과 관련된 쓰레드의 개수를 설정할 때, 코어의 개수와 동일하게 가져가면 될까요 ?\n<br> <strong>결론부터 이야기하면, 그렇지 않습니다 !</strong>\n<br> 실제 어플리케이션에서는 데이터를 저장하고 있는 <code class=\"language-text\">디스크</code>를 고려해야 하기 때문입니다.</p>\n<p>어플리케이션에서 사용하는 데이터베이스에는 디스크가 존재합니다.\n<br> 데이터를 읽기 위해서는, 물리적인 <code class=\"language-text\">Disk Arm과 Spindle</code>이 동작합니다.\n<br> 원하는 데이터를 찾기 위해 위와 같은 동작을 수행하며, 이때 드는 비용은 상당히 큽니다.\n<br> 이 시간을, <code class=\"language-text\">I/O 대기 시간</code>이라고 부르며, 해당 시간 동안 쓰레드들은 <code class=\"language-text\">waiting</code> 상태로 대기하게 됩니다.</p>\n<p>그렇기 때문에, I/O 대기 시간으로 인해 waiting 상태인 쓰레드가 생기게 됩니다.\n<br> 즉, 일하지 않고 놀게 되는 코어가 생기게 됩니다.</p>\n<p>그렇다면, 데이터베이스 Connection과 관련된 <code class=\"language-text\">Thread Pool</code>의 크기는 어느 정도로 관리하는 게 좋을까요 ?</p>\n<h3>Hikari Connection Pool</h3>\n<p><code class=\"language-text\">HikariCP</code> 공식 문서에서는 아래와 같은 추천 공식을 제공하고 있습니다.</p>\n<p><code class=\"language-text\">Connection Pool Size = (Core count * 2) + Effective spindle count</code></p>\n<p>위 공식에서, <code class=\"language-text\">Effective spindle count</code>의 값은 사실상 하드디스크의 개수와 같다고 보면 됩니다.\n<br> 디스크 1개당, 1개의 물리적 spindle을 가지고 있기 때문이죠.</p>\n<p><code class=\"language-text\">괜찮을지도</code> 서비스의 운영 서버 EC2 환경은 2개의 코어와 1개의 디스크를 사용하고 있습니다.\n<br> 이를 위 공식에 대입해 보면, <code class=\"language-text\">Connection Pool Size = 2 * 2 + 1 = 5</code></p>\n<p><strong>즉, <code class=\"language-text\">HikariCP</code>에서 추천하는 커넥션 풀 사이즈는 5가 나오게 됩니다.</strong></p>\n<h3>성능 테스트</h3>\n<p><code class=\"language-text\">HikariCP</code>에서 추천하는 <code class=\"language-text\">괜찮을지도</code> 서비스의 커넥션 풀 사이즈는 <code class=\"language-text\">5</code>임을 알 수 있었습니다.\n<br> 하지만, 이는 단순히 이론적인 내용일 뿐 맹신할 수는 없습니다.\n<br> 그래서, <code class=\"language-text\">JMETER</code>를 이용한 성능 테스트를 수행하였습니다.\n<br> 테스트에서는 다른 설정을 동일하게 두고, 커넥션 풀 사이즈만 변경하며 진행했습니다.</p>\n<p>Connection Pool Size는 아래와 같이 yml 파일을 작성하여 수정할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">hikari</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">maximum-pool-size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span></code></pre></div>\n<p><strong>- Connection Pool Size 10</strong>\n<br> 기본 설정값인 10으로 설정한 뒤, 테스트를 수행하였습니다.\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/10a26b46520773c5069bbf584dacfc38/90f05/connection_pool_size_10.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkUlEQVR42o2R3XKbMBCFef+Hyk1nOpM06bSOsZ1icOyMkzgIIYEkJP5Od8GxL3rRMPPNWS1nj4SI0sMR6TbF29s7CllCiAKikP+HfWc+CKk0lvEaUd8P4GccR4ysX2Bg73hd943nJo6vr4isD/Bthya0k36FhpXnnIe3DVypMRiL/f6AyPkeLvSwvpv0X6g/eQa4dpi9LsCpGq52hIVpWnT0bpft6YQNGahhXEvaXXFnppre2QCrLawyMLKae76fqMnTEln6jEjbFowypGauL1CgrhpURYVK1qiUg2ZMOHvCNFPWdGI/IEkokIMUNUozh3KteIPSQOUaisIuvbOHA5QJl7WsPAz9l6eU7lDQjpIMhTSQpUVRtyh0AymqCe4XNMA9Vh7+1E+Eoq9wPTYJ3eFJOojSIT8piPcSOTHpRwVB4dJ0FBBo0w5CB8Ijp4BcXfVE88oOWP2hwN+rFMvNDovNMx7XOzzGWyzWGeLtC+5/rXH7sMT3uwV+cP0zxip5Ac+skgNpNmuc4ik74ubbHf4CH4H7TrRWz6MAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='connection_pool_size_10.png' title='' src='/static/10a26b46520773c5069bbf584dacfc38/ca1dc/connection_pool_size_10.png' srcset='/static/10a26b46520773c5069bbf584dacfc38/e7570/connection_pool_size_10.png 170w,\n/static/10a26b46520773c5069bbf584dacfc38/f46e7/connection_pool_size_10.png 340w,\n/static/10a26b46520773c5069bbf584dacfc38/ca1dc/connection_pool_size_10.png 680w,\n/static/10a26b46520773c5069bbf584dacfc38/90f05/connection_pool_size_10.png 917w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>connection_pool_size_10.png</figcaption>\n  </figure></p>\n<p><strong>- Connection Pool Size 5</strong>\n<br> HikariCP에서 제공하는 공식을 통해 도출된 값으로 설정한 뒤, 테스트를 수행하였습니다.\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/8128bf50f73117b45859fedc872bdb32/3fcec/connection_pool_size_5.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABVUlEQVR42l2R2XajQBBD+f9PnAzBxomTGJql9wVHoy7MHCcP96haJRUPNLfLG+ZVY9UGMSaUsgm5lJ+aH7pVj5ntjlzzPiCTFCISM402lssN9+/vPXSEn1UO3fe384Icsg6lwrlUnx9ovoYRPmaEVISYN+GYw/Ob5eACgo+I1GMfyh0xJPGbtuvh0wYbiuBCJnWmVt8luMXCzwbOeNi4CS5uj/yj5yKc5cG/3QXGF5KhWTYuy1tX1R5GaRgG9eEfO6Kl98AwowOaP+2ZgYLFZswMLTZhnS2WkT9qdljpL4dvd/0/m12FNWBZPZrz+wC1Rkw0JmUwDQumyUItHhMLSnNHnvW3J9Q+e8110Bh4UM0eSvGQ5hGTMVLHNfFopneQhOqP7PzQumO/afsvvF4GdO8K5+uMlvP5OtG7of+Y8XL6lPnl9IG2v6F7G9Ex00tmkMyu+/sf6Qu0us/J3qoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='connection_pool_size_5.png' title='' src='/static/8128bf50f73117b45859fedc872bdb32/ca1dc/connection_pool_size_5.png' srcset='/static/8128bf50f73117b45859fedc872bdb32/e7570/connection_pool_size_5.png 170w,\n/static/8128bf50f73117b45859fedc872bdb32/f46e7/connection_pool_size_5.png 340w,\n/static/8128bf50f73117b45859fedc872bdb32/ca1dc/connection_pool_size_5.png 680w,\n/static/8128bf50f73117b45859fedc872bdb32/3fcec/connection_pool_size_5.png 914w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>connection_pool_size_5.png</figcaption>\n  </figure></p>\n<p>유의미한 TPS 차이를 통해, 커넥션 풀 사이즈가 5일 때의 성능이 좋다는 것을 확인할 수 있었습니다.\n<br> 물론, 트래픽 양에 따라, 다른 값을 적용하였을 때가 더 최적의 성능을 나타낼 수 있습니다.</p>\n<p><code class=\"language-text\">괜찮을지도</code> 서비스에서는 성능 테스트 목표치량을 기준으로 테스트를 수행하였기 때문에, 위와 같은 결과가 도출되었습니다.</p>\n<h3>마치며</h3>\n<p><strong>위에서도 이야기했지만, 공식을 통해 도출된 값이 항상 최적인 것은 아닙니다.</strong>\n<br><strong>각 서비스의 특성에 맞게, 커넥션 풀 사이즈를 설정해 보시면서 테스트를 수행하여 최적의 값을 도출해 내시길 바랍니다.</strong></p>\n<p>또한, 커넥션 풀 외에도 HikariCP에서 튜닝해야할 설정을 추천하고 있습니다.\n<br> 이 부분도 <a href=\"https://github.com/brettwooldridge/HikariCP/wiki/MySQL-Configuration\">참고</a>하면 좋을 것 같습니다.</p>\n<h3>참고</h3>\n<p><a href=\"https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing\">HikariCP docs</a>\n<br><a href=\"https://github.com/brettwooldridge/HikariCP/wiki/MySQL-Configuration\">HikariCP MySQL Configuration</a></p>","frontmatter":{"title":"HikariCP 적용기","date":"October 10, 2023","update":"October 10, 2023","tags":["데이터베이스","HikariCP","커넥션 풀"],"series":null},"fields":{"slug":"/how-to-hikariCP/","readingTime":{"minutes":5.8}}},"seriesList":{"edges":[{"node":{"id":"9e6463d2-18de-5fdf-b4e6-8707709710e1","fields":{"slug":"/how-to-write-a-post/"},"frontmatter":{"title":"포스트 작성 방법"}}},{"node":{"id":"b802f2fe-d332-504c-be84-fd7aa170c622","fields":{"slug":"/github-actions-ci-cd/"},"frontmatter":{"title":"GitHub Actions로 CI/CD 구축하기"}}},{"node":{"id":"45b7dc00-ae71-58e4-9dc2-7aff92f0ca0d","fields":{"slug":"/trouble-shooting-actions-runner/"},"frontmatter":{"title":"EC2 환경 변수 적용 및 Actions Runner에 환경 변수 적용이 안되는 이슈"}}},{"node":{"id":"cb221d09-1977-59c9-9bc3-cd607a15d292","fields":{"slug":"/how-to-isolating-test/"},"frontmatter":{"title":"인수테스트에서 테스트 격리하기!"}}},{"node":{"id":"fa602b8b-64fa-59b0-b377-089612f91d9f","fields":{"slug":"/how-to-use-nginx/"},"frontmatter":{"title":"괜찮을지도의 Nginx 활용법"}}},{"node":{"id":"89dc33ed-1ad0-5d79-8148-b1a16f417a71","fields":{"slug":"/trouble-shooting-modifying-annotation/"},"frontmatter":{"title":"@Modifying 어노테이션의 옵션이 정상 동작하지 않는 문제"}}},{"node":{"id":"db91695e-5bf6-554c-bafd-e161d686fadf","fields":{"slug":"/trouble-shooting-fetch-type/"},"frontmatter":{"title":"FetchType.EAGER, FetchType.LAZY 에 대해서 알아보자!"}}},{"node":{"id":"2b3c31ce-d59e-50a0-92b2-7dc228aacf29","fields":{"slug":"/jpa-multibag-fetch-exception/"},"frontmatter":{"title":"Fetch join 사용 시 MultipleBagFetchException의 발생 이유와 해결 방법"}}},{"node":{"id":"253d110b-e241-549e-923a-f26782aab2dc","fields":{"slug":"/how-to-hikariCP/"},"frontmatter":{"title":"HikariCP 적용기"}}}]},"previous":{"fields":{"slug":"/jpa-multibag-fetch-exception/"},"frontmatter":{"title":"Fetch join 사용 시 MultipleBagFetchException의 발생 이유와 해결 방법"}},"next":null},"pageContext":{"id":"253d110b-e241-549e-923a-f26782aab2dc","series":null,"previousPostId":"2b3c31ce-d59e-50a0-92b2-7dc228aacf29","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}