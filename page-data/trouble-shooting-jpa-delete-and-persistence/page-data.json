{"componentChunkName":"component---src-templates-post-jsx","path":"/trouble-shooting-jpa-delete-and-persistence/","result":{"data":{"site":{"siteMetadata":{"title":"ê´œì°®ì„ì§€ë„"}},"markdownRemark":{"id":"50f61fc3-c2e2-5599-b7e8-64879a64275d","excerpt":"ì´ ê¸€ì€ ìš°í…Œì½” ê´œì°®ì„ì§€ë„ì˜ ê°€ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. ì‚­ì œ ê¸°ëŠ¥ì— ëŒ€í•œ ë¦¬íŒ©í„°ë§ ì¤‘, íšŒì› ì°¨ë‹¨ì— ëŒ€í•œ ê¸°ì¡´ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ ì´ë¥¼ í•´ê²°í•´ì•¼ í–ˆëŠ”ë°ìš”. JPAì— ëŒ€í•œ ì§€ì‹ì´ ë¶€ì¡±í•œ ìƒíƒœì—ì„œ ì‚½ì§ˆì„ í•˜ë©° ì•Œê²Œ ëœ ê²ƒë“¤ì„ ê¸°ë¡í•˜ê³ ì í•©ë‹ˆë‹¤. ë¬¸ì œ ìƒí™© 1 : ì¿¼ë¦¬ì˜ ë°œìƒ ì‹œì  ì°¾ê¸° ë„ë©”ì¸: íšŒì› ì°¨ë‹¨ ê¸°ëŠ¥ ë„ë©”ì¸ì— ëŒ€í•´ ë¨¼ì € ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ê´€ë¦¬ì APIì—ì„œ íšŒì›â€¦","html":"<blockquote>\n<p>ì´ ê¸€ì€ ìš°í…Œì½” ê´œì°®ì„ì§€ë„ì˜ <code class=\"language-text\">ë„ì´</code>ê°€ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.</p>\n</blockquote>\n<p>ì‚­ì œ ê¸°ëŠ¥ì— ëŒ€í•œ ë¦¬íŒ©í„°ë§ ì¤‘, íšŒì› ì°¨ë‹¨ì— ëŒ€í•œ ê¸°ì¡´ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ ì´ë¥¼ í•´ê²°í•´ì•¼ í–ˆëŠ”ë°ìš”.<br>\nJPAì— ëŒ€í•œ ì§€ì‹ì´ ë¶€ì¡±í•œ ìƒíƒœì—ì„œ ì‚½ì§ˆì„ í•˜ë©° ì•Œê²Œ ëœ ê²ƒë“¤ì„ ê¸°ë¡í•˜ê³ ì í•©ë‹ˆë‹¤.</p>\n<h2>ë¬¸ì œ ìƒí™© 1 : ì¿¼ë¦¬ì˜ ë°œìƒ ì‹œì  ì°¾ê¸°</h2>\n<h3>ë„ë©”ì¸: íšŒì› ì°¨ë‹¨ ê¸°ëŠ¥</h3>\n<p>ë„ë©”ì¸ì— ëŒ€í•´ ë¨¼ì € ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.<br>\nê´€ë¦¬ì APIì—ì„œ íšŒì›ì„ ì°¨ë‹¨í•˜ë©´, ì°¨ë‹¨í•œ íšŒì›ì˜ ì§€ë„ <code class=\"language-text\">Topic</code>, í•€ <code class=\"language-text\">Pin</code>, í•€ ì´ë¯¸ì§€ <code class=\"language-text\">PinImage</code>ë¥¼ ì‚­ì œ ìƒíƒœ(soft delete)ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.<br>\nê·¸ë¦¬ê³  ë§¤í•‘ í…Œì´ë¸” ì—­í• ì„ í•˜ëŠ” ì—”í‹°í‹°ì¸ <code class=\"language-text\">Bookmark ì¦ê²¨ì°¾ê¸°</code>, <code class=\"language-text\">Atlas ëª¨ì•„ë³´ê¸°</code>, <code class=\"language-text\">Permission ê¶Œí•œ</code>ì€ ì‹¤ì œë¡œ ì‚­ì œ(hard delete)í•©ë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">blockMember</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token function\">findMemberById</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        member<span class=\"token punctuation\">.</span><span class=\"token function\">updateStatus</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BLOCKED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">deleteAllRelated</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteAllRelated</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> pinIds <span class=\"token operator\">=</span> <span class=\"token function\">extractPinIdsByMember</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Long</span> memberId <span class=\"token operator\">=</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        permissionRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        atlasRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        bookmarkRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pinImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByPinIds</span><span class=\"token punctuation\">(</span>pinIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pinRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        topicRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>ì•„ë˜ì™€ ê°™ì´ ë™ì‘í•˜ê¸°ë¥¼ ê¸°ëŒ€í–ˆìŠµë‹ˆë‹¤.</p>\n<ol>\n<li>ì°¨ë‹¨í•  íšŒì›ì— ëŒ€í•œ ì •ë³´ ì¡°íšŒ</li>\n<li>íšŒì›ì˜ ìƒíƒœë¥¼ ì°¨ë‹¨ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” update ì¿¼ë¦¬ ë°œìƒ</li>\n<li>ë§¤í•‘ í…Œì´ë¸” ì—”í‹°í‹°ë“¤ì„ ë¨¼ì € ì‚­ì œí•´ì•¼ í•¨, ì´ ë•Œ delete ì¿¼ë¦¬ ë°œìƒ</li>\n<li>ì£¼ìš” ë„ë©”ì¸ ì—”í‹°í‹°ë“¤ì„ ì‚­ì œ ìƒíƒœë¡œ ë³€ê²½í•˜ëŠ” update ì¿¼ë¦¬ ë°œìƒ</li>\n</ol>\n<h3>ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì˜ì† ë™ì‘</h3>\n<p>í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Memberë¥¼ ì°¨ë‹¨(íƒˆí‡´ì‹œí‚¬)í•  ê²½ìš°, Memberê°€ ìƒì„±í•œ ì§€ë„, í•€, í•€ ì´ë¯¸ì§€ë¥¼ ì‚­ì œ ìƒíƒœ(soft delete)ë¡œ ë³€ê²½í•œë‹¤.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">blockMember_Success</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//given</span>\n        <span class=\"token comment\">// ...    </span>\n        <span class=\"token comment\">// ê°ì²´ ìƒì„±, ì €ì¥ ë° ê¸°ì¡´ ìƒíƒœ ê²€ì¦ ì½”ë“œ ìƒëµ</span>\n        <span class=\"token comment\">// ...</span>\n            \n        <span class=\"token comment\">//when</span>\n        adminCommandService<span class=\"token punctuation\">.</span><span class=\"token function\">blockMember</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//then</span>\n        <span class=\"token class-name\">Member</span> blockedMember <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">assertAll</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>blockedMember<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span><span class=\"token constant\">BLOCKED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ì‹¤íŒ¨</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>bookmarkRepository<span class=\"token punctuation\">.</span><span class=\"token function\">existsByMemberIdAndTopicId</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> topic<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isFalse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ì‹¤íŒ¨</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>atlasRepository<span class=\"token punctuation\">.</span><span class=\"token function\">existsByMemberIdAndTopicId</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> topic<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isFalse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ì‹¤íŒ¨</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>permissionRepository<span class=\"token punctuation\">.</span><span class=\"token function\">existsByTopicIdAndMemberId</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isFalse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// ì‹¤íŒ¨</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>topicRepository<span class=\"token punctuation\">.</span><span class=\"token function\">existsById</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isFalse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>pinRepository<span class=\"token punctuation\">.</span><span class=\"token function\">existsById</span><span class=\"token punctuation\">(</span>pin<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isFalse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>pinImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">existsById</span><span class=\"token punctuation\">(</span>pinImage<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isFalse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>í•˜ì§€ë§Œ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ ë¡œê·¸ë¥¼ ë³´ë‹ˆ, ì‹¤ì œ ë™ì‘ì€ ì•„ë˜ì™€ ê°™ì•˜ìŠµë‹ˆë‹¤. ğŸ˜§ğŸ˜§</p>\n<ol>\n<li>ì°¨ë‹¨í•  íšŒì›ì— ëŒ€í•œ ì •ë³´ ì¡°íšŒ</li>\n<li><del>íšŒì›ì˜ ìƒíƒœë¥¼ ì°¨ë‹¨ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” update ì¿¼ë¦¬ ë°œìƒ</del></li>\n<li><del>ë§¤í•‘ í…Œì´ë¸” ì—”í‹°í‹°ë“¤ì„ ë¨¼ì € ì‚­ì œí•´ì•¼ í•¨, ì´ ë•Œ delete ì¿¼ë¦¬ ë°œìƒ</del></li>\n<li>ì£¼ìš” ë„ë©”ì¸ ì—”í‹°í‹°ë“¤ì„ ì‚­ì œ ìƒíƒœë¡œ ë³€ê²½í•˜ëŠ” update ì¿¼ë¦¬ ë°œìƒ</li>\n</ol>\n<p><code class=\"language-text\">// when</code> ì ˆì˜ ì½”ë“œë¥¼ í˜¸ì¶œí•œ ë’¤ entityManagerë¡œ flush, clearë¥¼ í•´ì£¼ì–´ë„ ë§ˆì°¬ê°€ì§€ì˜€ìŠµë‹ˆë‹¤.  </p>\n<h2>ì›ì¸</h2>\n<p>ì´ì „ì—ëŠ” ì˜ í†µê³¼í•˜ë˜ í…ŒìŠ¤íŠ¸ì¸ë°, ì™œ ê°‘ìê¸° ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ì‘ë™í• ê¹Œìš”?<br>\nJPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ì“°ê¸° ì§€ì—° ë•Œë¬¸ì´ì—ˆìŠµë‹ˆë‹¤.  </p>\n<ol>\n<li>hard delete ë©”ì„œë“œë¥¼ í†µí•´ í•´ë‹¹ idë¥¼ ê°€ì§„ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œê±°í•œë‹¤.</li>\n<li>soft delete ë©”ì„œë“œë¥¼ í†µí•´ updateë¥¼ í˜¸ì¶œí•˜ë©´ì„œ, ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì´ ëª¨ë‘ ì˜ì†í™”ëœë‹¤.<br>\nâ¡ï¸ (1)ì—ì„œ delete í•´ë„, 2ì—ì„œ ì¡°íšŒí•  ë•Œ í•¨ê»˜ ë¶ˆëŸ¬ì™€ì§€ëŠ” <code class=\"language-text\">member</code>, <code class=\"language-text\">permission</code>, <code class=\"language-text\">atlas</code>, <code class=\"language-text\">bookmark</code>ê¹Œì§€ ë‹¤ì‹œ ì˜ì†í™”ëœë‹¤.   </li>\n<li>ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ëŠ” <code class=\"language-text\">(ì°¨ë‹¨ ìƒíƒœê°€ ì•„ë‹Œ)member</code>, <code class=\"language-text\">permission</code>, <code class=\"language-text\">atlas</code>, <code class=\"language-text\">bookmark</code>ê°€ ì¡´ì¬í•œë‹¤.</li>\n<li><code class=\"language-text\">blockMember()</code> í˜¸ì¶œ í›„ flushë¥¼ í•  ë•Œ, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ìƒíƒœë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.<br>\nâ¡ï¸ memberì˜ ì°¨ë‹¨ ìƒíƒœì— ëŒ€í•œ ë³€ê²½ ê°ì§€ë„ ë˜ì§€ ì•Šê³ , delete ì¿¼ë¦¬ë„ ë‚˜ê°€ì§€ ì•ŠëŠ”ë‹¤.</li>\n</ol>\n<p>ê·¸ë˜ì„œ <code class=\"language-text\">blockMember()</code> ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œ ë’¤ flushë¥¼ í•´ì¤˜ë„ ì†Œìš©ì´ ì—†ì—ˆë˜ ê²ƒì…ë‹ˆë‹¤.  </p>\n<h2>í•´ê²°</h2>\n<p>ë‹¨ìˆœíˆ í•´ê²°ë¶€í„° í•´ë³´ìë©´,<br>\nsoft delete ë©”ì„œë“œë¡œ ì¸í•œ ì˜ì†í™”ê°€ ë˜ê¸° ì´ì „ì— flushí•´ì„œ memberì˜ ë³€ê²½, hard deleteì— ëŒ€í•œ ì¿¼ë¦¬ë¥¼ ë°œìƒì‹œí‚¤ë©´ ë©ë‹ˆë‹¤.  </p>\n<h3>flushë¡œ ì¿¼ë¦¬ ë°œìƒ ì‹œì  ì¡°ì •í•˜ê¸°</h3>\n<p>ì•„ë˜ ì²˜ëŸ¼ ì„œë¹„ìŠ¤ ë‹¨ì—ì„œ í•´ì£¼ê±°ë‚˜, <code class=\"language-text\">@Modifying</code> ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteAllRelated</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        permissionRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        atlasRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        bookmarkRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// flush!</span>\n        bookmarkRepository<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pinImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByPinIds</span><span class=\"token punctuation\">(</span>pinIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pinRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        topicRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h2>ë¬¸ì œ ìƒí™© 2 : í…ŒìŠ¤íŠ¸ì—ì„œ ë°œìƒí•˜ì§€ ì•ŠëŠ” ì¼ë¶€ ì¿¼ë¦¬</h2>\n<p>ê·¸ëŸ°ë°ë„ í…ŒìŠ¤íŠ¸ëŠ” ì„±ê³µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ¥²<br>\n<code class=\"language-text\">delete bookmark~</code> ì¿¼ë¦¬ëŠ” ì—¬ì „íˆ ë°œìƒí•˜ì§€ ì•Šê³  ìˆì—ˆìŠµë‹ˆë‹¤.  </p>\n<p>í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì™€ <code class=\"language-text\">blockMember()</code>ëŠ” ê°™ì€ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì´ê¸° ë•Œë¬¸ì— <code class=\"language-text\">// when</code>ì ˆì—ì„œì˜ ì˜ì†í™” ìƒíƒœ ë•Œë¬¸ì¼ ê²ƒì´ë¼ ì§ì‘í–ˆìŠµë‹ˆë‹¤.<br>\n<code class=\"language-text\">bookmark</code>ë¥¼ ì°¸ì¡°í•˜ëŠ” <code class=\"language-text\">topic</code>, ë˜ëŠ” <code class=\"language-text\">member</code> ê°ì²´ê°€ ì˜ì†í™”ë˜ì–´ìˆê¸° ë•Œë¬¸ì— delete ì¿¼ë¦¬ê°€ ë‚˜ê°€ì§€ ì•ŠëŠ” ê²ƒì´ë¼ ìƒê°í–ˆìŠµë‹ˆë‹¤.  </p>\n<p>ê·¸ë˜ì„œ ì´ì— ëŒ€í•´ì„œëŠ” <code class=\"language-text\">blockMember()</code> í˜¸ì¶œ ì „ì— <code class=\"language-text\">testEntityManager.clear()</code>ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•´ë‘ëŠ” ê²ƒìœ¼ë¡œ í•´ê²°í–ˆìŠµë‹ˆë‹¤.  </p>\n<p><strong>í•˜ì§€ë§Œ ì •í™•í•œ ì›ì¸ì´ ê¶ê¸ˆí–ˆìŠµë‹ˆë‹¤.\nì™œ <code class=\"language-text\">atlas</code>, <code class=\"language-text\">permission</code>ì€ ì‚­ì œë˜ê³  <code class=\"language-text\">bookmark</code>ë§Œ ì‚­ì œë˜ì§€ ì•Šì•˜ì„ê¹Œìš”?</strong>  </p>\n<h2>ì›ì¸</h2>\n<p>ë‹¤ë¥¸ ë§¤í•‘ í…Œì´ë¸” ì—”í‹°í‹°ë“¤ê³¼ <code class=\"language-text\">bookmark</code>ì˜ ì°¨ì´ì ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.<br>\ní•´ë‹¹ ì—”í‹°í‹°ë§Œì´ <code class=\"language-text\">topic</code>ê³¼ì˜ ì—°ê´€ ê´€ê³„ì—ì„œ <code class=\"language-text\">CasecadeType.PERSIST</code>ê°€ ê±¸ë ¤ ìˆì—ˆìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">// Topic.class</span>\n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSIST</span><span class=\"token punctuation\">,</span> orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> bookmarks <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì˜ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì¡´ì¬í•˜ëŠ” <code class=\"language-text\">topic</code>ì— <code class=\"language-text\">bookmark</code>ê°€ ì‚´ì•„ìˆê¸° ë•Œë¬¸ì—<br>\n<code class=\"language-text\">PERSIST OPERATION</code>ì´ ë°œìƒí•˜ê³  <code class=\"language-text\">bookmark</code>ì— ëŒ€í•œ delete ì¿¼ë¦¬ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤.  </p>\n<blockquote>\n<p><a href=\"https://download.oracle.com/otndocs/jcp/persistence-2_2-mrel-eval-spec/index.html\">JPA 2.2 specification</a> ë¬¸ì„œ 3.2 ì¥ Entity Instance's Life Cycleì— ë”°ë¥´ë©´,<br>\nflushê°€ ë°œìƒí•  ë•Œ <code class=\"language-text\">CascadeType.PERSIST</code>ë‚˜ <code class=\"language-text\">CascadeType.ALL</code>ì´ ìˆì„ ê²½ìš° ìì‹ì— ì—°ì‡„ì ìœ¼ë¡œ <code class=\"language-text\">PERSIST OPERATION</code>ì´ ë°œìƒí•©ë‹ˆë‹¤.\n<code class=\"language-text\">PERSIST OPERATION</code>ì€ ì—°ê´€ ê´€ê³„ ë§¤í•‘ëœ listì˜ ì—”í‹°í‹°ì— ëŒ€í•´ ëª¨ë‘ ì´ë£¨ì–´ì§€ë©°, ê¸°ì¡´ì— ì—†ë˜ ê°’ì´ë©´ ìƒˆë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p>\n</blockquote>\n<h2>í•´ê²°</h2>\n<p>ì´ì— ëŒ€í•´ì„œ ì—”í‹°í‹°ì— ê±¸ì–´ë†“ì€ ì¡°ê±´ì— ë”°ë¼ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ í•˜ë ¤ë©´,<br>\n<code class=\"language-text\">bookmarkRepository</code>ë¥¼ í†µí•´ delete ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•˜ëŠ” ëŒ€ì‹  ì—°ê´€ ê´€ê³„ë¥¼ ì œê±°í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‚­ì œí•´ì£¼ì—ˆì–´ì•¼ í–ˆë˜ ê²ƒì…ë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">// Topic.class</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">removeBookmarkBy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        bookmarks<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>bookmark <span class=\"token operator\">-></span> bookmark<span class=\"token punctuation\">.</span><span class=\"token function\">getMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isSame</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">ifPresent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">::</span><span class=\"token function\">removeBookmark</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        bookmarkCount<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// AdminCommandService.class</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteAllRelatedMember</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> pinIds <span class=\"token operator\">=</span> <span class=\"token function\">extractPinIdsByMember</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Long</span> memberId <span class=\"token operator\">=</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        permissionRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        atlasRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// ë³€ê²½ëœ ë¶€ë¶„</span>\n        topicRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findTopicsByBookmarksMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>topic <span class=\"token operator\">-></span> topic<span class=\"token punctuation\">.</span><span class=\"token function\">removeBookmarkBy</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        atlasRepository<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pinImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByPinIds</span><span class=\"token punctuation\">(</span>pinIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        pinRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        topicRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteAllByMemberId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>ì•„ë˜ì™€ ê°™ì´ <code class=\"language-text\">bookmark</code>ì— ëŒ€í•œ ì‚­ì œ ë¡œì§ì„ ìˆ˜ì •í•˜ë‹ˆ,<br>\ní…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ë³„ë„ì˜ <code class=\"language-text\">clear</code>ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ ì˜ í†µê³¼í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>\n<h2>ê²°ë¡ </h2>\n<p>ì´ë²ˆ ì‚½ì§ˆì„ ê³„ê¸°ë¡œ JPAë¥¼ ì˜ í•™ìŠµí•œ ë’¤ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” êµí›ˆì„ ë‹¤ì‹œ í•œ ë²ˆ ëª¸ì†Œ ëŠê¼ˆìŠµë‹ˆë‹¤..  </p>\n<p>ì—”í‹°í‹°ì˜ ìƒëª… ì£¼ê¸°ì— ëŒ€í•´ ì˜ ì´í•´í•˜ê³  ê°ì²´ë¥¼ ìƒì„± ë° ì‚­ì œí•´ì•¼í•œë‹¤ëŠ” ê²ƒ, ì‚­ì œí•  ë•Œì—ë„ ì—°ê´€ ê´€ê³„ì˜ ê´€ë¦¬ê°€ ì¤‘ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œì•˜ìŠµë‹ˆë‹¤.\nì´ì²˜ëŸ¼ ì˜ˆìƒí•˜ì§€ ëª»í•œ ë™ì‘ì„ í”¼í•˜ê¸° ìœ„í•´ ì‚­ì œ ë¡œì§ì—ì„œë„ ì—°ê´€ ê´€ê³„ í¸ì˜ ë©”ì„œë“œë¥¼ ì •ì˜í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì½”ë“œë¥¼ ì˜ ì‘ì„±í•  í•„ìš”ê°€ ìˆì–´ ë³´ì…ë‹ˆë‹¤. </p>\n<h2>ì°¸ê³  ìë£Œ</h2>\n<ul>\n<li><a href=\"https://velog.io/@jsb100800/spring-12\">[Spring boot] JPA Delete is not Working, ì˜ì†ì„±ì™€ ì—°ê´€ ê´€ê³„ë¥¼ ê³ ë ¤í–ˆëŠ”ê°€.</a>  </li>\n<li><a href=\"https://joont92.github.io/jpa/CascadeType-PERSIST%EB%A5%BC-%ED%95%A8%EB%B6%80%EB%A1%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EB%A9%B4-%EC%95%88%EB%90%98%EB%8A%94-%EC%9D%B4%EC%9C%A0/\">[jpa] CascadeType.PERSISTë¥¼ í•¨ë¶€ë¡œ ì‚¬ìš©í•˜ë©´ ì•ˆë˜ëŠ” ì´ìœ </a></li>\n</ul>","frontmatter":{"title":"JPA ì—”í‹°í‹°ë¥¼ ì‚­ì œí•  ë•Œ ì˜ì†ì„±ê³¼ ì—°ê´€ ê´€ê³„ê°€ ì¤‘ìš”í•œ ì´ìœ ","date":"October 13, 2023","update":"October 13, 2023","tags":["Spring Data JPA","Hibernate","JPQL","íŠ¸ëŸ¬ë¸”ìŠˆíŒ…"],"series":null},"fields":{"slug":"/trouble-shooting-jpa-delete-and-persistence/","readingTime":{"minutes":8.945}}},"seriesList":{"edges":[{"node":{"id":"9e6463d2-18de-5fdf-b4e6-8707709710e1","fields":{"slug":"/how-to-write-a-post/"},"frontmatter":{"title":"í¬ìŠ¤íŠ¸ ì‘ì„± ë°©ë²•"}}},{"node":{"id":"b802f2fe-d332-504c-be84-fd7aa170c622","fields":{"slug":"/github-actions-ci-cd/"},"frontmatter":{"title":"GitHub Actionsë¡œ CI/CD êµ¬ì¶•í•˜ê¸°"}}},{"node":{"id":"45b7dc00-ae71-58e4-9dc2-7aff92f0ca0d","fields":{"slug":"/trouble-shooting-actions-runner/"},"frontmatter":{"title":"EC2 í™˜ê²½ ë³€ìˆ˜ ì ìš© ë° Actions Runnerì— í™˜ê²½ ë³€ìˆ˜ ì ìš©ì´ ì•ˆë˜ëŠ” ì´ìŠˆ"}}},{"node":{"id":"cb221d09-1977-59c9-9bc3-cd607a15d292","fields":{"slug":"/how-to-isolating-test/"},"frontmatter":{"title":"ì¸ìˆ˜í…ŒìŠ¤íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ ê²©ë¦¬í•˜ê¸°!"}}},{"node":{"id":"fa602b8b-64fa-59b0-b377-089612f91d9f","fields":{"slug":"/how-to-use-nginx/"},"frontmatter":{"title":"ê´œì°®ì„ì§€ë„ì˜ Nginx í™œìš©ë²•"}}},{"node":{"id":"89dc33ed-1ad0-5d79-8148-b1a16f417a71","fields":{"slug":"/trouble-shooting-modifying-annotation/"},"frontmatter":{"title":"@Modifying ì–´ë…¸í…Œì´ì…˜ì˜ ì˜µì…˜ì´ ì •ìƒ ë™ì‘í•˜ì§€ ì•ŠëŠ” ë¬¸ì œ"}}},{"node":{"id":"db91695e-5bf6-554c-bafd-e161d686fadf","fields":{"slug":"/trouble-shooting-fetch-type/"},"frontmatter":{"title":"FetchType.EAGER, FetchType.LAZY ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì!"}}},{"node":{"id":"2b3c31ce-d59e-50a0-92b2-7dc228aacf29","fields":{"slug":"/jpa-multibag-fetch-exception/"},"frontmatter":{"title":"Fetch join ì‚¬ìš© ì‹œ MultipleBagFetchExceptionì˜ ë°œìƒ ì´ìœ ì™€ í•´ê²° ë°©ë²•"}}},{"node":{"id":"253d110b-e241-549e-923a-f26782aab2dc","fields":{"slug":"/how-to-hikariCP/"},"frontmatter":{"title":"HikariCP ì ìš©ê¸°"}}},{"node":{"id":"50f61fc3-c2e2-5599-b7e8-64879a64275d","fields":{"slug":"/trouble-shooting-jpa-delete-and-persistence/"},"frontmatter":{"title":"JPA ì—”í‹°í‹°ë¥¼ ì‚­ì œí•  ë•Œ ì˜ì†ì„±ê³¼ ì—°ê´€ ê´€ê³„ê°€ ì¤‘ìš”í•œ ì´ìœ "}}}]},"previous":{"fields":{"slug":"/how-to-hikariCP/"},"frontmatter":{"title":"HikariCP ì ìš©ê¸°"}},"next":null},"pageContext":{"id":"50f61fc3-c2e2-5599-b7e8-64879a64275d","series":null,"previousPostId":"253d110b-e241-549e-923a-f26782aab2dc","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}