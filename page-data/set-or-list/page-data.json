{"componentChunkName":"component---src-templates-post-jsx","path":"/set-or-list/","result":{"data":{"site":{"siteMetadata":{"title":"괜찮을지도"}},"markdownRemark":{"id":"5a782fff-6a5b-55c2-af81-7c69e2b2ddac","excerpt":"이 글은 우테코 괜찮을지도의 가 작성하였습니다. 서론 간단한 도메인 설명 저희 서비스에는  이라는 도메인이 존재하고, 이는 를 의미합니다. 그리고 해당 는 , ,  들과  를 이루고 있습니다. 문제 발생 상황 문제 상황 이 글에서 주로 탐구하고 있는 문제는 서비스 홍보를 앞두고 성능 개선을 하기 위해  문제를 해결하고 있던 와중 발생하였습니다. 일단 유의…","html":"<blockquote>\n<p>이 글은 우테코 괜찮을지도의 <code class=\"language-text\">매튜</code>가 작성하였습니다.</p>\n</blockquote>\n<h3>서론</h3>\n<h2>간단한 도메인 설명</h2>\n<p>저희 서비스에는 <code class=\"language-text\">Topic</code> 이라는 도메인이 존재하고, 이는 <code class=\"language-text\">지도</code>를 의미합니다.</p>\n<p>그리고 해당 <code class=\"language-text\">지도</code>는 <code class=\"language-text\">Permission(권한)</code>, <code class=\"language-text\">Pin(핀)</code>, <code class=\"language-text\">Bookmark(즐겨찾기)</code> 들과 <code class=\"language-text\">1:N</code> <code class=\"language-text\">연관관계</code>를 이루고 있습니다.</p>\n<h2>문제 발생 상황</h2>\n<h3>문제 상황</h3>\n<p>이 글에서 주로 탐구하고 있는 문제는 서비스 홍보를 앞두고 성능 개선을 하기 위해 <code class=\"language-text\">N + 1</code> 문제를 해결하고 있던 와중 발생하였습니다.</p>\n<p>일단 유의미한 성능 차이를 보기 위해, 우선적으로 <code class=\"language-text\">Topic</code> 과 <code class=\"language-text\">Pin</code> 데이터를 각각 <code class=\"language-text\">10만개</code>씩 넣고 진행하였습니다.</p>\n<p>또한 요청은 <code class=\"language-text\">PostMan</code> 을 이용하여 테스트 하였습니다.</p>\n<p>아래는 그 때의 <code class=\"language-text\">코드</code>입니다.</p>\n<ul>\n<li>\n<p>Topic</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>  \n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token constant\">PROTECTED</span><span class=\"token punctuation\">)</span>  \n<span class=\"token annotation punctuation\">@Getter</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Topic</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseTimeEntity</span> <span class=\"token punctuation\">{</span>  \n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 생략\n\n<span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span>  \n<span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"member_id\"</span><span class=\"token punctuation\">)</span>  \n<span class=\"token keyword\">private</span> <span class=\"token class-name\">Member</span> creator<span class=\"token punctuation\">;</span>  \n\n<span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">)</span>  \n<span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Permission</span><span class=\"token punctuation\">></span></span> permissions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\n<span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSIST</span><span class=\"token punctuation\">)</span>  \n<span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Pin</span><span class=\"token punctuation\">></span></span> pins <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\n<span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSIST</span><span class=\"token punctuation\">,</span> orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>  \n<span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> bookmarks <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 생략</code></pre></div>\n</li>\n</ul>\n<p>}</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- TopicRepository\n```java\n@Repository  \npublic interface TopicRepository extends JpaRepository&lt;Topic, Long> {  \n\n    @EntityGraph(attributePaths = {\"creator\", \"permissions\", \"bookmarks\", \"pins\"})  \n    List&lt;Topic> findAll();  \n\n}</code></pre></div>\n<p>당연히 위 코드는 <code class=\"language-text\">MultipleBagFetchExcepion</code> 예외가 발생하였습니다. (<code class=\"language-text\">MultipleBagFetchExcepion</code> 자세한 설명은 <a href=\"https://map-befine-official.github.io/jpa-multibag-fetch-exception/\">https://map-befine-official.github.io/jpa-multibag-fetch-exception/</a> 해당 글을 확인해주세요!)</p>\n<h3>MultipleBagFetchExcepion 해결</h3>\n<p>우리는 해당 예외를 해결하기 위해 <code class=\"language-text\">Topic</code> 의 <code class=\"language-text\">Collection</code> 들의 <code class=\"language-text\">자료구조</code>를 <code class=\"language-text\">Set</code> 으로 바꿔주었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>  \n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token constant\">PROTECTED</span><span class=\"token punctuation\">)</span>  \n<span class=\"token annotation punctuation\">@Getter</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Topic</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseTimeEntity</span> <span class=\"token punctuation\">{</span>  \n\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 생략\n  \n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"member_id\"</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Member</span> creator<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Permission</span><span class=\"token punctuation\">></span></span> permissions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HasSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSIST</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Pin</span><span class=\"token punctuation\">></span></span> pins <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSIST</span><span class=\"token punctuation\">,</span> orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> bookmarks <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 생략\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 해서 단 한번의 <code class=\"language-text\">Query</code> 로 존재하는 모든 <code class=\"language-text\">Topic</code> 을 불러 올 수 있었습니다.</p>\n<p>하지만, <code class=\"language-text\">카테시안 곱</code> 으로 인해 요청에 대한 응답시간이 어마어마 했습니다. (대략 <code class=\"language-text\">20초</code> 정도?)</p>\n<h3>Topic findAll성능 개선 완료</h3>\n<p><code class=\"language-text\">Topic</code>을 전체 조회할 때 사실 <code class=\"language-text\">Bookmark(즐겨찾기)</code>, <code class=\"language-text\">Pin(핀)</code> 의 세부 정보가 아닌, 이들의 개수만이 필요하기 때문에, 반정규화를 통해 이 문제를 해결하였습니다.</p>\n<p>결론적으로 아래와 같이, <code class=\"language-text\">Collection</code> 중에는 <code class=\"language-text\">Permission</code> 만을 <code class=\"language-text\">join</code> 해오면 되는 거죠!</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Repository</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">TopicRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Topic</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>  \n\n    <span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>attributePaths <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"creator\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"permissions\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Topic</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>근데 이렇게 반정규화를 진행하던 도중, 어쩌다가 <code class=\"language-text\">Topic</code> 을 아래와 같이 바꾸는 일이 있었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>  \n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token constant\">PROTECTED</span><span class=\"token punctuation\">)</span>  \n<span class=\"token annotation punctuation\">@Getter</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Topic</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseTimeEntity</span> <span class=\"token punctuation\">{</span>  \n\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 생략\n  \n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"member_id\"</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Member</span> creator<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Permission</span><span class=\"token punctuation\">></span></span> permissions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HasSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSIST</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Pin</span><span class=\"token punctuation\">></span></span> pins <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Set --> List 로 바꿈</span>\n  \n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSIST</span><span class=\"token punctuation\">,</span> orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bookmark</span><span class=\"token punctuation\">></span></span> bookmarks <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 생략\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 때 <code class=\"language-text\">Collection</code> 의 자료구조를 <code class=\"language-text\">Set</code> 만을 썼을때보다 속도가 굉장히 빨라졌었습니다.</p>\n<p>이 때 당시에 모두 이에 대해 왜 이런 것이지? 하는 의문을 가졌었지만, 시간이 없어 어쩔 수 없이 넘어갔었습니다.</p>\n<p>그리고 시간이 지나, 어느정도 여유가 생긴 지금, 해당 문제에 대해 탐구해보고자 글을 작성하게 된 것입니다.</p>\n<h2>재연</h2>\n<h3>상황을 그때와 동일하게 구성해보자.</h3>\n<p><code class=\"language-text\">프로시저를</code> 통해 <code class=\"language-text\">Local DB</code> 에다가 <code class=\"language-text\">Topic</code>, <code class=\"language-text\">Bookmark</code> 데이터를 <code class=\"language-text\">10만개</code> 가량을 넣어주고 테스트를 진행했습니다. (내 컴퓨터 살려..)</p>\n<p><code class=\"language-text\">Pin</code> 데이터를 넣지 않은 이유는, 현재 <code class=\"language-text\">Pin</code> 은 <code class=\"language-text\">반정규화</code>가 진행되어 있어 <code class=\"language-text\">Topic</code> 전체 목록을 조회할 때, 성능에 전혀 영향을 끼치지 않기 때문입니다.</p>\n<p>그렇다고 <code class=\"language-text\">Pin</code> <code class=\"language-text\">반정규화</code>를 풀자니, 요청과 응답 시간이 비 정상적으로 너무 길어졌습니다. (대략 1분 30초 정도)</p>\n<p>그렇기 때문에 일단 <code class=\"language-text\">Pin</code> 은 일단 <code class=\"language-text\">반정규화</code>를 유지하였고, <code class=\"language-text\">Bookmark</code> 만 <code class=\"language-text\">반정규화</code>를 해제하고 진행하였습니다.</p>\n<p>그렇기 때문에 테스트를 위해서 <code class=\"language-text\">자료구조</code>를 변경하게 될 <code class=\"language-text\">Collection</code> 은 사실상 <code class=\"language-text\">Permission</code> 과 <code class=\"language-text\">Bookmark</code> 뿐인 것 입니다.</p>\n<h3>테스트 진행</h3>\n<p>말씀드린 두 <code class=\"language-text\">Collection</code>의  <code class=\"language-text\">자료구조</code>를 바꿔가며 테스트 해본 결과는 아래와 같습니다. (<code class=\"language-text\">Permission</code>, <code class=\"language-text\">Bookmark</code> 모두 <code class=\"language-text\">Set</code> 이 아닌 경우는 <code class=\"language-text\">MultipleBagFetchException</code>  이 발생하기 때문에 테스트하지 않았습니다.)</p>\n<ul>\n<li>\n<p>Permission, Bookmark 모두 Set</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">[http-nio-8080-exec-2] 2042 INFO  com.mapbefine.mapbefine.common.filter.LatencyLoggingFilter - Latency : 5.442s, Query count : 1, Request URI : /topics</code></pre></div>\n</li>\n<li>\n<p>Permission  만 Set </p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">[http-nio-8080-exec-3] 2181 INFO  com.mapbefine.mapbefine.common.filter.LatencyLoggingFilter - Latency : 7.074s, Query count : 1, Request URI : /topics</code></pre></div>\n</li>\n<li>\n<p>Bookmark 만 Set</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">[http-nio-8080-exec-1] 2072 INFO  com.mapbefine.mapbefine.common.filter.LatencyLoggingFilter - Latency : 5.348s, Query count : 1, Request URI : /topics</code></pre></div>\n</li>\n</ul>\n<p>위 테스트 결과들만으로는 <code class=\"language-text\">유의미한 차이</code>가 보이지 않아 <code class=\"language-text\">원인</code>을 추론해보기 어려웠습니다.</p>\n<h3>지금까지 무의미한 데이터로 테스트 해본 것은 아닐까?</h3>\n<p>위와 같이 테스트하다가, 문득 <code class=\"language-text\">Permission</code> 에 <code class=\"language-text\">데이터</code>도 넣어봐야 유의미하지 않을까? 란 생각이 머리를 스쳐 지나갔고, <code class=\"language-text\">Permission</code> 데이터도 추가해주었습니다.</p>\n<p>하지만, <code class=\"language-text\">Permission</code> 을 추가해주니, <code class=\"language-text\">카제인 곱</code>이 엄청나게 발생되어, <code class=\"language-text\">Permission</code>, <code class=\"language-text\">Bookmark</code> 각각 데이터 개수가 <code class=\"language-text\">3000개</code>만 넘어가도 <code class=\"language-text\">Java Heap</code> 이 터지는 예외가 발생하게 되어, 적당히 <code class=\"language-text\">2000</code> 개 가량의 데이터를 각각 넣어주고, 이어서 테스트를 진행해본 결과 아래와 같은 결과가 나오게 되었습니다.</p>\n<ul>\n<li>\n<p>Permission 과 Bookmark 모두  Set</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">[http-nio-8080-exec-3] 1863 INFO  com.mapbefine.mapbefine.common.filter.LatencyLoggingFilter - Latency : 4.924s, Query count : 1, Request URI : /topics</code></pre></div>\n</li>\n<li>\n<p>Permission 만 Set 일 때</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">[http-nio-8080-exec-2] 1952 INFO  com.mapbefine.mapbefine.common.filter.LatencyLoggingFilter - Latency : 5.159s, Query count : 1, Request URI : /topics</code></pre></div>\n</li>\n<li>\n<p>Bookmark 만 Set 일 때</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">[http-nio-8080-exec-3] 2000 INFO  com.mapbefine.mapbefine.common.filter.LatencyLoggingFilter - Latency : 7.253s, Query count : 1, Request URI : /topics</code></pre></div>\n</li>\n</ul>\n<p>테스트 데이터를 변경하더라도, 역시나 <code class=\"language-text\">유의미한 차이</code>를 볼 수 없었습니다.</p>\n<h3>내린 결론 (가설)</h3>\n<p><code class=\"language-text\">Set</code> 자료구조를 사용함에 따라, <code class=\"language-text\">List</code> 보다는 부하가 더 발생할 수 있다고 생각합니다.</p>\n<p>자료구조 특성상 <code class=\"language-text\">Set</code> 은 중복을 제거해주는 연산을 실행해주어야 하니까요.</p>\n<p>하지만, 어짜피 <code class=\"language-text\">List</code> 를 사용하더라도 <code class=\"language-text\">hibernate</code> 에서 <code class=\"language-text\">distinct</code> 를 통해 <code class=\"language-text\">중복</code>을 제거해주기 때문에 더더욱이 유의미한 성능상의 차이를 가져오지 못하는 것 같습니다.</p>\n<p>정말 많이 테스트해보면서, 가끔 컴퓨터의 상태에 따라 응답시간이 비정상적으로 길어지는 경우가 있었습니다.</p>\n<p>저희는 그것을 보았던 것 아닐까요??</p>\n<h2>이대로 끝내기는 아쉬우니까!</h2>\n<h3>JPA 에서 Set 을 사용할 때 주의할 점</h3>\n<p><code class=\"language-text\">문제</code>를 탐구하다가 <code class=\"language-text\">재미있는 글</code>을 발견했습니다.</p>\n<p><a href=\"https://www.inflearn.com/questions/321256/collection-type%EC%9C%BC%EB%A1%9C-set-%EB%8C%80%EC%8B%A0-list%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0%EA%B0%80-%EC%9E%88%EB%8A%94%EC%A7%80%EC%9A%94\">JPA 에서 Set 을 사용할 때 주의점</a></p>\n<p>질문은 아래와 같았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">Collection type으로 Set 대신 List를 사용하시는 이유가 궁금합니다.\n\n지금까지 나온 Collection들이 모두 unique한 Entity(또는 값 타입)들의 collection이기 때문에, Set을 활용할 경우 중복 확인 관련 부분이 깔끔해지고, 다른 질문의 답변에서 답해주신대로 값 타입 컬렉션에도 row를 모두 날리고 다시 넣는 문제를 막을 수 있어 Set에 대해 좋은 인상을 가지게 되었습니다.\n\n그런데 기본적으로 예제가 List를 사용하여, Set을 사용하였을 때 제가 놓친 문제가 있는지 의문이 들었습니다.</code></pre></div>\n<p>그에 대한 영한님의 답변은 이랬습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">안녕하세요. Catnip님\n\n좋은 질문입니다. Set이 개념적으로 좋지만 실무에서는 성능 이슈가 있습니다.\n\nSet은 중복을 제거해야 하는데, 그렇다는 것은 기존 데이터 중에 중복이 있는지 비교를 해야 합니다. 이게 일반적으로는 크게 문제가 없는데, 지연 로딩으로 컬렉션을 조회했을 때 문제가 됩니다.\n\n컬력션이 아직 초기화 되지 않은 상태에서 컬렉션에 값을 넣게 되면 프록시가 강제로 초기화 되는 문제가 발생합니다. 왜냐하면 중복 데이터가 있는지 비교해야 하는데, 그럴러면 컬렉션에 모든 데이터를 로딩해야 하기 때문입니다.\n\n반면에 List는 이런 중복 체크가 필요없이 때문에 데이터를 추가할 때 초기화가 발생하지 않습니다.\n\n감사합니다.</code></pre></div>\n<p>아주 흥미로웠습니다.</p>\n<p>이를 제대로 확인해보기 위해서 테스트를 진행하였습니다.</p>\n<h3>테스트</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>  \n<span class=\"token annotation punctuation\">@Transactional</span>  \n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Topic</span>의_Collection_의_자료구조에_따른_초기화를_확인해보자<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token comment\">//given  </span>\n    <span class=\"token class-name\">Member</span> savedMember <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MemberFixture</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"member\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"member@naver.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Role</span><span class=\"token punctuation\">.</span><span class=\"token constant\">USER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">Topic</span> savedTopic <span class=\"token operator\">=</span> topicRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TopicFixture</span><span class=\"token punctuation\">.</span><span class=\"token function\">createPublicAndAllMembersTopic</span><span class=\"token punctuation\">(</span>savedMember<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">Location</span> savedLocation <span class=\"token operator\">=</span> locationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocationFixture</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token comment\">// when  </span>\n    entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">Topic</span> findTopic <span class=\"token operator\">=</span> topicRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>savedTopic<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">Pin</span> savedPin <span class=\"token operator\">=</span> pinRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PinFixture</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>savedLocation<span class=\"token punctuation\">,</span> savedTopic<span class=\"token punctuation\">,</span> savedMember<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token comment\">// then  </span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"=============Add Pin 이전\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    findTopic<span class=\"token punctuation\">.</span><span class=\"token function\">addPin</span><span class=\"token punctuation\">(</span>savedPin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"=============Add Pin 이후\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이와 같이 테스트 코드를 짜고 <code class=\"language-text\">Pins</code> 를 <code class=\"language-text\">List</code> 혹은 <code class=\"language-text\">Set</code> 으로 진행해보았다.</p>\n<ul>\n<li>\n<p>Pins 가 List 일 때 쿼리</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">... 이전 쿼리들\n=============Add Pin 이전\n=============Add Pin 이후\nHibernate: \nupdate\n    topic \nset\n    ... 수 많은 컬럼들\nwhere\n    id=?</code></pre></div>\n</li>\n<li>\n<p>Pins 가 Set 일 때 쿼리</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">... 이전 쿼리들\n=============Add Pin 이전\nHibernate: \nselect\n\t... 수 많은 컬럼들\nfrom\n    pin p1_0 \nleft join\n    member c1_0 \n        on c1_0.id=p1_0.member_id \nleft join\n    location l1_0 \n        on l1_0.id=p1_0.location_id \nwhere\n    p1_0.topic_id=? \n    and (\n        p1_0.is_deleted = false\n    ) \n=============Add Pin 이후\nHibernate: \nupdate\n    topic \nset\n\t... 수 많은 컬럼들\nwhere\n    id=?</code></pre></div>\n</li>\n</ul>\n<p>영한님의 말씀대로 <code class=\"language-text\">List</code> 는 <code class=\"language-text\">Collection</code> 에 값을 <code class=\"language-text\">추가</code> 를 진행할 때, 기존의 데이터가 필요 없으니, 초기화를 진행하지 않지만, <code class=\"language-text\">Set</code> 을 쓰는 경우 중복을 방지하기 위해 기존의 데이터가 필요하기 때문에 <code class=\"language-text\">select</code> 를 통해 값을 가져와 초기화를 진행해주는 것을 볼 수 있었습니다.</p>\n<p>즉, 이렇게 <code class=\"language-text\">fetch</code> 전략으로 <code class=\"language-text\">Lazy Loading</code> 을 사용하는 경우 <code class=\"language-text\">자료구조</code>로 <code class=\"language-text\">Set</code> 을 사용하는 경우, <code class=\"language-text\">연관관계 매핑</code>을 하게 되었을 때, 해당 <code class=\"language-text\">부작용</code>이 발생할 수 있는 것입니다.</p>\n<p>조심해서 써야겠습니다.</p>\n<h2>최종적인 결론</h2>\n<p>이 글의 최종적인 결론은 아래와 같습니다.</p>\n<ul>\n<li>사실 <code class=\"language-text\">Set</code> 과 <code class=\"language-text\">List</code> 로 인한 <code class=\"language-text\">성능 차이</code>는 <code class=\"language-text\">유의미하지 않은</code> 것 같다. 우리가 착각했던 것일지도..?</li>\n<li>하지만, <code class=\"language-text\">Set</code> 을 무지성으로 써도 되는 것은 아니다, 이로부터 얻는 부작용이 상당히 많으니, 고심해서 사용하자 (순서 보장 x, 위에서 설명한 초기화 문제)</li>\n</ul>\n<p>긴 글 봐주셔서 정말 감사합니다~!</p>","frontmatter":{"title":"N + 1 문제 해결 도중 맞닥뜨린 Set 과 List 의 차이","date":"October 15, 2023","update":"October 15, 2023","tags":["Spring Data JPA","Hibernate"],"series":null},"fields":{"slug":"/set-or-list/","readingTime":{"minutes":13.815}}},"seriesList":{"edges":[{"node":{"id":"9e6463d2-18de-5fdf-b4e6-8707709710e1","fields":{"slug":"/how-to-write-a-post/"},"frontmatter":{"title":"포스트 작성 방법"}}},{"node":{"id":"b802f2fe-d332-504c-be84-fd7aa170c622","fields":{"slug":"/github-actions-ci-cd/"},"frontmatter":{"title":"GitHub Actions로 CI/CD 구축하기"}}},{"node":{"id":"45b7dc00-ae71-58e4-9dc2-7aff92f0ca0d","fields":{"slug":"/trouble-shooting-actions-runner/"},"frontmatter":{"title":"EC2 환경 변수 적용 및 Actions Runner에 환경 변수 적용이 안되는 이슈"}}},{"node":{"id":"cb221d09-1977-59c9-9bc3-cd607a15d292","fields":{"slug":"/how-to-isolating-test/"},"frontmatter":{"title":"인수테스트에서 테스트 격리하기!"}}},{"node":{"id":"fa602b8b-64fa-59b0-b377-089612f91d9f","fields":{"slug":"/how-to-use-nginx/"},"frontmatter":{"title":"괜찮을지도의 Nginx 활용법"}}},{"node":{"id":"89dc33ed-1ad0-5d79-8148-b1a16f417a71","fields":{"slug":"/trouble-shooting-modifying-annotation/"},"frontmatter":{"title":"@Modifying 어노테이션의 옵션이 정상 동작하지 않는 문제"}}},{"node":{"id":"db91695e-5bf6-554c-bafd-e161d686fadf","fields":{"slug":"/trouble-shooting-fetch-type/"},"frontmatter":{"title":"FetchType.EAGER, FetchType.LAZY 에 대해서 알아보자!"}}},{"node":{"id":"2b3c31ce-d59e-50a0-92b2-7dc228aacf29","fields":{"slug":"/jpa-multibag-fetch-exception/"},"frontmatter":{"title":"Fetch join 사용 시 MultipleBagFetchException의 발생 이유와 해결 방법"}}},{"node":{"id":"253d110b-e241-549e-923a-f26782aab2dc","fields":{"slug":"/how-to-hikariCP/"},"frontmatter":{"title":"HikariCP 적용기"}}},{"node":{"id":"50f61fc3-c2e2-5599-b7e8-64879a64275d","fields":{"slug":"/trouble-shooting-jpa-delete-and-persistence/"},"frontmatter":{"title":"JPA 엔티티를 삭제할 때 영속성과 연관 관계가 중요한 이유"}}},{"node":{"id":"5a782fff-6a5b-55c2-af81-7c69e2b2ddac","fields":{"slug":"/set-or-list/"},"frontmatter":{"title":"N + 1 문제 해결 도중 맞닥뜨린 Set 과 List 의 차이"}}},{"node":{"id":"4a76962f-5c50-5617-84e6-286b77281734","fields":{"slug":"/how-to-optimize-website/"},"frontmatter":{"title":"괜찮을지도 사이트 최적화 진행"}}},{"node":{"id":"17b8f808-e28d-5eb8-a407-fba6191a1ea7","fields":{"slug":"/how-to-store-image-s3/"},"frontmatter":{"title":"백엔드와 협력해 S3에 이미지 저장하기"}}}]},"previous":{"fields":{"slug":"/trouble-shooting-jpa-delete-and-persistence/"},"frontmatter":{"title":"JPA 엔티티를 삭제할 때 영속성과 연관 관계가 중요한 이유"}},"next":{"fields":{"slug":"/how-to-optimize-website/"},"frontmatter":{"title":"괜찮을지도 사이트 최적화 진행"}}},"pageContext":{"id":"5a782fff-6a5b-55c2-af81-7c69e2b2ddac","series":null,"previousPostId":"50f61fc3-c2e2-5599-b7e8-64879a64275d","nextPostId":"4a76962f-5c50-5617-84e6-286b77281734"}},"staticQueryHashes":[],"slicesMap":{}}